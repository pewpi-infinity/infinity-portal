
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Watson: Divot Healer — System UI Build</title>
<style>
  :root{
    --bg:#0b0f12;
    --ink:#ffffff;
    --accent:#7ecbff;     /* blue wire glow */
    --accent2:#ff4d4d;    /* red boundary */
    --pulse:#e6fff7;      /* sequinoid spark */
    --ui:#11161b;
    --ui2:#1b222a;
    --good:#6dff9a;
    --warn:#ffd36e;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:#e7eef6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  canvas{display:block;width:100vw;height:100vh;touch-action:none}
  /* HUD */
  .hud{position:fixed;inset:0;pointer-events:none}
  .badge{
    position:absolute;left:12px;top:12px;background:linear-gradient(180deg,var(--ui2),var(--ui));
    color:#cfe8ff;border:1px solid #2b3642;border-radius:14px;padding:8px 12px;
    font-weight:700;letter-spacing:.3px;pointer-events:auto;box-shadow:0 6px 18px rgba(0,0,0,.35);
  }
  .badge small{display:block;font-weight:500;color:#90a7bd;letter-spacing:.2px}
  .panel{
    position:absolute;right:12px;bottom:12px;max-width:min(92vw,420px);
    background:linear-gradient(180deg,var(--ui2),var(--ui));border:1px solid #2b3642;border-radius:16px;
    padding:10px 12px;pointer-events:auto;box-shadow:0 10px 28px rgba(0,0,0,.45)
  }
  .panel h3{margin:6px 0 8px 0;font-size:14px;letter-spacing:.3px;text-transform:uppercase;color:#bcd1e4}
  .panel .row{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    background:#0f1419;border:1px solid #2c3946;color:#bcd1e4;
    padding:8px 10px;border-radius:12px;min-width:64px;text-align:center;flex:1 1 auto;
    user-select:none
  }
  .chip[data-active="true"]{border-color:#68a7ff;box-shadow:inset 0 0 0 1px #68a7ff;background:#0b1220}
  .footer{
    position:absolute;left:12px;bottom:12px;display:flex;gap:10px;pointer-events:auto;align-items:center
  }
  .btn{
    appearance:none;background:#0e1420;border:1px solid #2c3946;color:#dfe9f6;
    padding:12px 14px;border-radius:14px;font-weight:700;letter-spacing:.3px;min-width:60px;
    box-shadow:0 6px 18px rgba(0,0,0,.35)
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{border-color:#69f;box-shadow:0 0 0 2px rgba(100,150,255,.15), 0 10px 24px rgba(0,0,0,.4)}
  .meter{
    height:10px;border-radius:999px;background:#101820;border:1px solid #2b3642;overflow:hidden;margin-top:6px
  }
  .meter > i{display:block;height:100%;width:40%;background:linear-gradient(90deg,#2ad0a8,#6dff9a)}
  /* Mini radar */
  .radar{
    position:absolute;right:12px;top:12px;width:110px;height:110px;border-radius:14px;background:#0d141b;border:1px solid #2b3642;
    pointer-events:auto;box-shadow:0 10px 28px rgba(0,0,0,.45);display:grid;place-items:center
  }
  .radar canvas{width:100px;height:100px}
  /* Virtual joystick */
  .stick{
    position:absolute;left:12px;bottom:92px;width:120px;height:120px;border-radius:50%;border:1px solid #2b3642;background:#0e141b88;
    pointer-events:auto;touch-action:none;display:grid;place-items:center;backdrop-filter:blur(2px)
  }
  .nub{
    width:58px;height:58px;border-radius:50%;border:1px solid #47586a;background:#0a0f15;box-shadow:inset 0 0 0 2px #101923;
    display:block;transform:translate(0,0)
  }
  /* Onboarding tip */
  .toast{
    position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0a121a;color:#d6e6ff;
    padding:10px 14px;border:1px solid #2b3642;border-radius:14px;pointer-events:none;opacity:.95
  }
  /* Top progress strip */
  .topbar{position:fixed;left:0;top:0;width:100%;height:3px;background:#0e151d}
  .topbar i{display:block;height:100%;width:0;background:linear-gradient(90deg,#69f,#6dff9a)}
  /* Overlay msg */
  .center{
    position:fixed;inset:0;display:grid;place-items:center;pointer-events:none
  }
  .msg{padding:14px 18px;background:#0d141b;border:1px solid #2b3642;border-radius:16px;color:#bcd1e4;box-shadow:0 12px 32px rgba(0,0,0,.45)}
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- HUD -->
<div class="hud">
  <div class="badge" id="status">
    Watson: Divot Healer<br><small>System UI Build • seq energy <b id="energy">0%</b></small>
    <div class="meter"><i id="energyBar"></i></div>
  </div>

  <div class="radar"><canvas id="radar"></canvas></div>

  <div class="panel">
    <h3>Frequency Gates</h3>
    <div class="row" id="freqRow"></div>
    <h3 style="margin-top:10px">Downhill / Uphill</h3>
    <div class="row">
      <button class="chip" id="brake">Brake (pole flip)</button>
      <button class="chip" id="glide" data-active="true">Glide</button>
      <button class="chip" id="boost">Boost (downhill)</button>
    </div>
  </div>

  <div class="footer">
    <button class="btn primary" id="pulse">Pulse</button>
    <button class="btn" id="heal">Align</button>
    <button class="btn" id="next">Next Target</button>
  </div>

  <div class="stick" id="stick"><span class="nub" id="nub"></span></div>

  <div class="topbar"><i id="topprog"></i></div>
</div>

<div class="center" id="centerMsg" style="display:none">
  <div class="msg" id="msgText">Divot healed ✓</div>
</div>

<div class="toast" id="tip">Drag the joystick to steer. Tap <b>Pulse</b> near the divot to inject energy.</div>

<script>
/* Utility */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const rand=(a,b)=>Math.random()*(b-a)+a;
const TAU=Math.PI*2;

/* Canvas setup */
const cvs=document.getElementById('game');
const ctx=cvs.getContext('2d');
const DPR=Math.min(2, window.devicePixelRatio||1);
function resize(){
  cvs.width=innerWidth*DPR;
  cvs.height=innerHeight*DPR;
}
resize(); addEventListener('resize',resize);

/* World state */
const state={
  watson:{x:0,y:0,vx:0,vy:0,dir:0,speed:0,energy:0},
  divots:[],
  line:[], // vertical Watson stream
  pulses:[],
  gates: [10,20,30,40,50,60,70,80,90,100,110,120,130].map(hz=>({hz,open:hz===10})),
  downhill:0, // -1 brake, 0 glide, +1 boost
  healProgress:0,
  targetIndex:0,
  phase:0,
};
function init(){
  const w=cvs.width,h=cvs.height;
  state.watson.x=w*0.72; state.watson.y=h*0.55;
  // Build vertical stream on right side
  state.line = Array.from({length:14}, (_,i)=>({x:w*0.86, y:h*(0.15+i*0.06)}));
  // Seed a few divots on left
  state.divots = [
    newDivot(w*0.18, h*0.58, Math.min(w,h)*0.26),
    newDivot(w*0.22, h*0.34, Math.min(w,h)*0.22),
    newDivot(w*0.20, h*0.78, Math.min(w,h)*0.24),
  ];
  state.targetIndex=0;
  state.healProgress=0;
  document.getElementById('topprog').style.width='0%';
}
function newDivot(x,y,r){
  return {x,y,r,damage:1.0, swirl:[]};
}
init();

/* Controls: joystick */
const stick=document.getElementById('stick');
const nub=document.getElementById('nub');
let stickActive=false, stickR=54;
function posFromEvent(e){
  const t = (e.touches && e.touches[0]) || e;
  const rect = stick.getBoundingClientRect();
  return {x:t.clientX-rect.left, y:t.clientY-rect.top};
}
function handleStickStart(e){stickActive=true; const p=posFromEvent(e); moveStick(p.x,p.y); e.preventDefault()}
function handleStickMove(e){ if(!stickActive) return; const p=posFromEvent(e); moveStick(p.x,p.y); e.preventDefault()}
function handleStickEnd(){ stickActive=false; nub.style.transform='translate(0px,0px)'; }
function moveStick(x,y){
  const dx=x-60, dy=y-60;
  const d=Math.hypot(dx,dy);
  const ux= dx/(d||1), uy=dy/(d||1);
  const m = Math.min(d, stickR);
  nub.style.transform=`translate(${ux*m}px,${uy*m}px)`;
  state.watson.dir=Math.atan2(uy,ux);
  state.watson.speed = lerp(state.watson.speed, 2.5 + 1.5*Math.min(1,d/stickR), 0.25);
}
stick.addEventListener('pointerdown', handleStickStart);
stick.addEventListener('pointermove', handleStickMove);
addEventListener('pointerup', handleStickEnd);
stick.addEventListener('touchstart', handleStickStart, {passive:false});
stick.addEventListener('touchmove', handleStickMove, {passive:false});
stick.addEventListener('touchend', handleStickEnd);

/* Buttons */
const chip=(id)=>document.getElementById(id);
chip('brake').onclick=()=>{state.downhill=-1; setModeChip('brake')}
chip('glide').onclick=()=>{state.downhill=0; setModeChip('glide')}
chip('boost').onclick=()=>{state.downhill=+1; setModeChip('boost')}
function setModeChip(id){
  ['brake','glide','boost'].forEach(k=>chip(k).dataset.active=(k===id));
}
document.getElementById('pulse').onclick=()=>pulse();
document.getElementById('heal').onclick=()=>align();
document.getElementById('next').onclick=()=>nextTarget();

/* Frequency gates UI */
const freqRow=document.getElementById('freqRow');
state.gates.forEach((g,i)=>{
  const b=document.createElement('button');
  b.className='chip'; b.textContent=g.hz+' Hz'; b.dataset.active = g.open;
  b.onclick=()=>{ g.open=!g.open; b.dataset.active=g.open; };
  freqRow.appendChild(b);
});

/* Radar */
const radar=document.getElementById('radar');
const rctx=radar.getContext('2d');
radar.width=100*DPR; radar.height=100*DPR;
function drawRadar(){
  const t=performance.now()/1000;
  rctx.clearRect(0,0,radar.width,radar.height);
  const cx=radar.width/2, cy=radar.height/2, R=radar.width*0.44;
  // grid
  rctx.strokeStyle='#203040'; rctx.lineWidth=1;
  [0.33,0.66,1].forEach(f=>{ rctx.beginPath(); rctx.arc(cx,cy,R*f,0,Math.PI*2); rctx.stroke(); });
  // sweep
  rctx.beginPath(); rctx.moveTo(cx,cy);
  const ang = (t*1.8)%(Math.PI*2);
  rctx.arc(cx,cy,R,ang-0.3,ang+0.01);
  const g=rctx.createRadialGradient(cx,cy,0,cx,cy,R);
  g.addColorStop(0,'rgba(104,153,255,.35)'); g.addColorStop(1,'rgba(104,153,255,0)');
  rctx.fillStyle=g; rctx.fill();
  // blips
  const target = state.divots[state.targetIndex];
  function plot(x,y){ return {x: cx + (x - state.watson.x)/400, y: cy + (y - state.watson.y)/400}; }
  const tp=plot(target.x,target.y);
  rctx.fillStyle='#6dff9a'; rctx.beginPath(); rctx.arc(tp.x,tp.y,4,0,Math.PI*2); rctx.fill();
  const wp=plot(state.watson.x,state.watson.y);
  rctx.fillStyle='#ffffff'; rctx.beginPath(); rctx.arc(wp.x,wp.y,3,0,Math.PI*2); rctx.fill();
}

/* Core mechanics */
function pulse(){
  const openHz = state.gates.filter(g=>g.open).map(g=>g.hz);
  if(openHz.length===0) return tip('Open at least one gate');
  const fan = Math.max(6, Math.min(24, openHz.length*3));
  for(let i=0;i<fan;i++){
    const jitter = (i-(fan-1)/2)/((fan-1)/2);
    const ang = state.watson.dir + jitter*0.35;
    const spd = 4 + (state.downhill===1?2.0:0) - (state.downhill===-1?1.2:0);
    state.pulses.push({
      x: state.watson.x + Math.cos(ang)*18*DPR,
      y: state.watson.y + Math.sin(ang)*18*DPR,
      vx: Math.cos(ang)*spd*DPR,
      vy: Math.sin(ang)*spd*DPR,
      life: 1.8,
      amp: lerp(.4,1.0, Math.random()),
    });
  }
  state.watson.energy = clamp(state.watson.energy + 0.06, 0, 1);
  setEnergy();
}
function align(){
  const t = state.divots[state.targetIndex];
  if(!t) return;
  const ang = Math.atan2(t.y-state.watson.y, t.x-state.watson.x);
  state.watson.dir = ang;
  tip('Aligned');
}
function nextTarget(){
  state.targetIndex = (state.targetIndex+1)%state.divots.length;
  state.healProgress=0;
  document.getElementById('topprog').style.width='0%';
}
function setEnergy(){
  document.getElementById('energy').textContent = Math.round(state.watson.energy*100)+'%';
  document.getElementById('energyBar').style.width = (state.watson.energy*100)+'%';
}

/* Heal on impact */
function tryHeal(p){
  const t = state.divots[state.targetIndex];
  if(!t) return;
  const d = Math.hypot(p.x - t.x, p.y - t.y);
  if(d < t.r*0.55){
    const k = 0.0025 * (state.downhill===1?1.8:1.0) * p.amp;
    t.damage = clamp(t.damage - k, 0, 1);
    state.healProgress = 1 - t.damage;
    document.getElementById('topprog').style.width=(state.healProgress*100)+'%';
    if(t.damage<=0){
      showMsg('Divot healed ✓');
      const closed = state.gates.find(g=>!g.open);
      if(closed) closed.open=true;
      nextTarget();
    }
    return true;
  }
  return false;
}

/* On-screen tip */
let tipTimer=0;
function tip(txt){
  const el=document.getElementById('tip');
  el.innerHTML=txt;
  el.style.opacity='0.95';
  clearTimeout(tipTimer);
  tipTimer=setTimeout(()=>{el.style.opacity='0'}, 1800);
}
function showMsg(txt){
  const c=document.getElementById('centerMsg'); const m=document.getElementById('msgText');
  m.textContent=txt; c.style.display='grid'; setTimeout(()=>c.style.display='none',1200);
}

/* Loop */
let last=performance.now();
function loop(now){
  const dt=Math.min(0.033,(now-last)/1000); last=now;
  update(dt); draw(dt); drawRadar();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* Update physics */
function update(dt){
  const w= cvs.width, h=cvs.height;
  const p = state.watson;
  const accel = (state.downhill===1? 180 : state.downhill===-1? 40 : 90) * DPR;
  p.vx += Math.cos(p.dir) * accel * dt * (stickActive?0.6:0.25);
  p.vy += Math.sin(p.dir) * accel * dt * (stickActive?0.6:0.25);
  const damp = (state.downhill===-1? 0.90 : 0.96);
  p.vx *= damp; p.vy *= damp;
  p.x = clamp(p.x + p.vx*dt, 0, w); p.y = clamp(p.y + p.vy*dt, 0, h);
  p.energy = clamp(p.energy - 0.03*dt, 0, 1); setEnergy();

  for(let i=state.pulses.length-1;i>=0;i--){
    const s=state.pulses[i];
    s.x += s.vx; s.y += s.vy;
    s.life -= dt;
    const t = state.divots[state.targetIndex];
    if(t){
      const ax=(t.x-s.x), ay=(t.y-s.y); const L=Math.hypot(ax,ay)||1;
      const g=0.0022 * (state.downhill===1?1.4:1.0);
      s.vx += (ax/L)*g; s.vy += (ay/L)*g;
    }
    if(tryHeal(s)){ s.life-=0.12 }
    if(s.life<=0) state.pulses.splice(i,1);
  }
}

/* Draw */
function draw(dt){
  const w=cvs.width,h=cvs.height;
  ctx.clearRect(0,0,w,h);

  const g=ctx.createRadialGradient(w*0.25,h*0.55,10,w*0.25,h*0.55,h*0.9);
  g.addColorStop(0,'#0b0f12'); g.addColorStop(1,'#06090c');
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

  // Right vertical Watson stream
  ctx.fillStyle='#ffffff';
  const colX = w*0.86;
  for(let i=0;i<14;i++){
    const y=h*(0.15+i*0.06);
    ctx.beginPath(); ctx.arc(colX,y,8*DPR,0,Math.PI*2); ctx.fill();
  }

  // Target divot
  const t = state.divots[state.targetIndex];
  if(t){
    ctx.beginPath(); ctx.arc(t.x,t.y,t.r*1.06,0,Math.PI*2);
    const bg=ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,t.r*1.06);
    bg.addColorStop(0,'rgba(0,0,0,.7)'); bg.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=bg; ctx.fill();

    ctx.beginPath(); ctx.arc(t.x,t.y,t.r,0,Math.PI*2);
    ctx.fillStyle='white'; ctx.fill();
    ctx.lineWidth=4*DPR; ctx.strokeStyle='var(--accent2)'; ctx.stroke();

    if(t.damage>0){
      ctx.save();
      ctx.beginPath(); ctx.arc(t.x,t.y,t.r*clamp(0.75 + t.damage*0.23,0,1.2),0,Math.PI*2);
      ctx.clip();
      ctx.lineWidth=2*DPR; ctx.strokeStyle='var(--accent)';
      ctx.globalAlpha=0.9;
      for(let i=0;i<24;i++){
        ctx.beginPath();
        let a=rand(0,Math.PI*2);
        let R=t.r*rand(0.2,0.9);
        ctx.moveTo(t.x+Math.cos(a)*R, t.y+Math.sin(a)*R);
        for(let k=0;k<4;k++){
          a+=rand(-0.8,0.8);
          R=clamp(R+rand(-12,22), t.r*0.1, t.r*0.95);
          ctx.lineTo(t.x+Math.cos(a)*R, t.y+Math.sin(a)*R);
        }
        ctx.stroke();
      }
      ctx.restore();
    }
  }

  // Pulses
  for(const s of state.pulses){
    const a=clamp(s.life,0,1);
    ctx.globalAlpha = a;
    const r = 3*DPR + 3*s.amp;
    ctx.beginPath(); ctx.arc(s.x,s.y,r,0,Math.PI*2);
    const pg=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,r);
    pg.addColorStop(0,'#e6fff7'); pg.addColorStop(1,'rgba(230,255,247,0)');
    ctx.fillStyle=pg; ctx.fill();
  }
  ctx.globalAlpha=1;

  // Watson craft
  const p=state.watson; const R=18*DPR;
  ctx.beginPath(); ctx.arc(p.x,p.y,R,0,Math.PI*2);
  ctx.fillStyle='#fff'; ctx.fill();
  ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.dir);
  ctx.fillStyle='#fff'; ctx.beginPath(); ctx.moveTo(R-2*DPR,0); ctx.lineTo(R-10*DPR,6*DPR); ctx.lineTo(R-10*DPR,-6*DPR); ctx.closePath(); ctx.fill();
  ctx.restore();
  ctx.lineWidth=1.6*DPR; ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--accent');
  ctx.globalAlpha=0.85;
  for(let i=0;i<3;i++){
    ctx.beginPath();
    for(let a=0;a<=Math.PI*2;a+=0.3){
      const rr = R*(0.65 + 0.18*Math.sin(a*2 + i));
      ctx.lineTo(p.x+Math.cos(a+ i*0.8)*rr, p.y+Math.sin(a + i*0.8)*rr);
    }
    ctx.stroke();
  }
  ctx.globalAlpha=1;
}

/* Hide tip after a moment */
setTimeout(()=>document.getElementById('tip').style.opacity='0', 2600);
</script>
</body>
</html>
